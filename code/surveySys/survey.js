var resultList = {"code":200,"data":{"ver":1,"suitTerminal":0,"survey":[{"id":1,"question":"选择您的店铺类型","choicesType":2,"choices":[{"id":8,"choiceName":"国内电商","style":3,"value":null,"choices":[{"id":12,"choiceName":"淘宝","style":3,"value":"12","choices":[]},{"id":13,"choiceName":"天猫","style":3,"value":null,"choices":[]},{"id":14,"choiceName":"1688","style":3,"value":"14","choices":[]},{"id":15,"choiceName":"拼多多","style":3,"value":null,"choices":[]},{"id":16,"choiceName":"京东","style":3,"value":null,"choices":[]},{"id":17,"choiceName":"其他","style":3,"value":null,"choices":[]}]},{"id":9,"choiceName":"直播卖家","style":3,"value":null,"choices":[{"id":18,"choiceName":"抖音","style":3,"value":"18","choices":[]},{"id":19,"choiceName":"快手","style":3,"value":null,"choices":[]},{"id":20,"choiceName":"淘宝","style":3,"value":"20","choices":[]},{"id":21,"choiceName":"其他","style":3,"value":null,"choices":[]}]},{"id":10,"choiceName":"跨境电商","style":3,"value":null,"choices":[{"id":22,"choiceName":"速卖通","style":3,"value":"22","choices":[]},{"id":23,"choiceName":"亚马逊","style":3,"value":null,"choices":[]},{"id":24,"choiceName":"ebay","style":3,"value":"24","choices":[]},{"id":25,"choiceName":"虾皮","style":3,"value":null,"choices":[]},{"id":26,"choiceName":"自建站","style":3,"value":null,"choices":[]},{"id":27,"choiceName":"其他","style":3,"value":null,"choices":[]}]},{"id":11,"choiceName":"其他","style":3,"value":null,"choices":[{"id":28,"choiceName":"微商","style":3,"value":"28","choices":[]},{"id":29,"choiceName":"实体店店主","style":3,"value":null,"choices":[]},{"id":30,"choiceName":"批发商","style":3,"value":"30","choices":[]},{"id":31,"choiceName":"个人消费者","style":3,"value":null,"choices":[]},{"id":32,"choiceName":"其他","style":3,"value":null,"choices":[]}]}]},{"id":2,"question":"您的公司经营团队类型是？","choicesType":1,"choices":[{"id":33,"choiceName":"公司","style":3,"value":null,"choices":[]},{"id":34,"choiceName":"夫妻店/合伙","style":3,"value":null,"choices":[]},{"id":35,"choiceName":"个人全职","style":3,"value":"35","choices":[]},{"id":36,"choiceName":"个人兼职","style":3,"value":null,"choices":[]}]},{"id":3,"question":"您是如何了解到搜款网的？","choicesType":1,"choices":[{"id":37,"choiceName":"朋友推荐","style":3,"value":null,"choices":[]},{"id":38,"choiceName":"档口推荐","style":3,"value":null,"choices":[]},{"id":39,"choiceName":"线下曝光","style":3,"value":"39","choices":[]},{"id":40,"choiceName":"主动搜索","style":3,"value":null,"choices":[]},{"id":41,"choiceName":"线上平台","style":3,"value":null,"choices":[{"id":71,"choiceName":"知乎","style":3,"value":null,"choices":[]},{"id":72,"choiceName":"豆瓣","style":3,"value":null,"choices":[]},{"id":73,"choiceName":"抖音","style":3,"value":null,"choices":[]},{"id":74,"choiceName":"小红书","style":3,"value":null,"choices":[]},{"id":75,"choiceName":"其他","style":3,"value":null,"choices":[]}]},{"id":42,"choiceName":"其他","style":3,"value":null,"choices":[]}]},{"id":4,"question":"您主要采购哪些货源地的商品？","choicesType":2,"choices":[{"id":43,"choiceName":"广州十三行","style":3,"value":null,"choices":[]},{"id":44,"choiceName":"广州沙河南城万佳","style":3,"value":"44","choices":[]},{"id":45,"choiceName":"广州沙河网批","style":3,"value":"45","choices":[]},{"id":46,"choiceName":"广州四季青","style":3,"value":"46","choices":[]},{"id":47,"choiceName":"杭州濮院","style":3,"value":"47","choices":[]},{"id":48,"choiceName":"广东普宁","style":3,"value":"48","choices":[]},{"id":49,"choiceName":"广州新塘","style":3,"value":"49","choices":[]},{"id":50,"choiceName":"其他批发市场","style":4,"value":"真的是hjkiic1234`","choices":[]},{"id":51,"choiceName":"不清楚货源","style":3,"value":"51","choices":[]}]},{"id":5,"question":"您的从业年限？","choicesType":2,"choices":[{"id":52,"choiceName":"1年以内","style":3,"value":null,"choices":[]},{"id":53,"choiceName":"1-3年","style":3,"value":null,"choices":[]},{"id":54,"choiceName":"3-5年","style":3,"value":"54","choices":[]},{"id":55,"choiceName":"5-10年","style":3,"value":null,"choices":[]},{"id":56,"choiceName":"10年以上","style":3,"value":null,"choices":[]}]},{"id":6,"question":"春夏季您的店铺整体的月均出货量大约是？","choicesType":1,"choices":[{"id":57,"choiceName":"30件以内","style":3,"value":null,"choices":[]},{"id":58,"choiceName":"30-100件","style":3,"value":null,"choices":[]},{"id":59,"choiceName":"100-300件","style":3,"value":"59","choices":[]},{"id":60,"choiceName":"300-1000件","style":3,"value":null,"choices":[]},{"id":61,"choiceName":"1000-3000件","style":3,"value":null,"choices":[]},{"id":62,"choiceName":"3000-10000件","style":3,"value":null,"choices":[]},{"id":63,"choiceName":"10000件以上","style":3,"value":null,"choices":[]},{"id":64,"choiceName":"保密","style":3,"value":null,"choices":[]}]},{"id":7,"question":"春夏季您的店铺售卖商品的平均出货价大约是？","choicesType":1,"choices":[{"id":65,"choiceName":"30元及以下","style":3,"value":null,"choices":[]},{"id":66,"choiceName":"30-50元","style":3,"value":null,"choices":[]},{"id":67,"choiceName":"50-80元","style":3,"value":null,"choices":[]},{"id":68,"choiceName":"80-120元","style":3,"value":null,"choices":[]},{"id":69,"choiceName":"120-150元","style":3,"value":"69","choices":[]},{"id":70,"choiceName":"150元以上","style":3,"value":null,"choices":[]}]}],"finished":true},"message":"success"}

;(function (window, document) {
    define('survey',
        function (header, common, api) {

            var Main = function () {
                this.init()
            }

            $.extend(Main.prototype, {
                init: function () {
                    var self = this;
                    self.initEvent();
                    self.getSurveyList();
                },
                surveyData: {}, // 全局问卷结果
                currAddChoices: [], // 当前选中选项的子选项
                selectedValue: {}, // 默认已选的选项，用于生成初始已选效果
                newSelectedValue: {}, // 新已选的选项，判断是否更新
                otherSurveyData: {}, // 用户首题选中其他时的问卷数据切换
                surveyType: 'og', // 当前问卷类型 og —— 原始， simple —— 简易
                pageIndex: 0,
                initEvent: function () {
                    var _self = this;
                    // 问题选项点击事件
                    $(document).on('click', '.survey-wrapper .survey-content .item', function (event) {
                        const parentNode = $(event.target).parents('.row');
                        const currRowHeight = parentNode.height();
                        // 单选框更新单选状态
                        if (parentNode.hasClass('single-select')) {
                            // 单选框重复点击自身不做处理
                            if ($(event.target).hasClass('selected')) {
                                return;
                            }
                            // 当点击新增的三级选项时
                            if (_self.clickSubChoice(event)) {
                                return;
                            }
                            $.each(parentNode.find('.content .item'), (index, item) => {
                                $(item).removeClass('selected');
                                parentNode.find('.add-content').remove(); // 去除额外增加模块
                                if ($(item).hasClass('add-space')) {
                                    parentNode.css('height', currRowHeight - 55);
                                    $(item).removeClass('add-space');
                                }
                            })
                            $(event.target).addClass('selected');
                        } else {
                            // 多选框选框更新单选状态
                            $(event.target).toggleClass('selected');
                            if (!$(event.target).hasClass('selected') && $(event.target).data('style') == 4) {
                                parentNode.find('.add-content').remove(); // 去除额外增加模块
                            }
                        }
                        // 有再次展开下一层时 ———— 点击框或输入框
                        _self.toggleNextLevel(event.target);
                    }),
                    // 点击商铺类型确认提交按钮
                    $(document).on('click', '.user-main .go-submit', function () {
                        const selectedValues = {};
                        $.each($('.user-main .survey-wrapper .selected'), function (index, item) {
                            // 3 为勾选型，4为输入型
                            selectedValues[item.dataset.id] = item.dataset.style == 3 ? item.dataset.id : $(`#auto-${item.dataset.id} input`).val();
                            if ($(item).parents('.row').find('.row-title').data('id')) {
                                selectedValues[$(item).parents('.row').find('.row-title').data('id')] = $(item).parents('.row').find('.row-title').data('id').toString();
                            }
                        })
                        _self.newSelectedValue = selectedValues;
                        _self.updateSurvey(_self.surveyData.survey, selectedValues);
                        _self.submitSurvey();
                    }),
                    // 点击下一页时
                    $(document).on('click', '.user-main .go-next', function () {
                        _self.updatePage('next');
                    }),
                    // 点击上一页时
                    $(document).on('click', '.user-main .go-previous', function () {
                        _self.updatePage('pervious');
                    })

                },
                initPage: function () {
                    var _self = this;
                    $.each($('.user-main .survey-wrapper .item'), function (index, item) {
                        if (Object.keys(_self.selectedValue).includes($(item).data('id').toString())) {
                            $(item).addClass('selected');
                            // 判断是否展开下一层并遍历
                            _self.toggleNextLevel(item);
                            // 下层动态选择框
                            $.each($('.user-main .survey-wrapper .sub-item'), function (idx, subItem) {
                                if (Object.keys(_self.selectedValue).includes($(subItem).data('id').toString())) {
                                    $(subItem).addClass('selected');
                                }
                            })
                            // 下层动态输入框
                            $.each($('.user-main .survey-wrapper .add-content input'), function (idx, subItem) {
                                if (Object.keys(_self.selectedValue).includes($(subItem).data('id').toString())) {
                                    $(subItem).val(_self.selectedValue[$(subItem).data('id')]);
                                }
                            })
                        }
                    })
                    // 默认显示第一页
                    $.each($('.user-main .survey-wrapper .page'), function (index, item) {
                        if ($(item).data('page') !== 0) {
                            $(item).css('display', 'none');
                        }
                    })
                },
                toggleNextLevel(item) {
                    var _self = this;
                    const parentNode = $(item).parents('.row');
                    const currRowHeight = parentNode.height();
                    if (($(item).data('choices') && $(item).data('choices').length > 0) || ($(item).data('style') == 4)) {
                        if ($(item).hasClass('selected')) {
                            parentNode.css('height', currRowHeight + 55);
                            $(item).addClass('add-space'); // class用于标记已增加高度选择框
                            _self.addDynamicSurvey($(item), parentNode);
                        } else {
                            parentNode.css('height', currRowHeight - 55);
                        }
                    }
                },
                getSurveyList: function () {
                    var _self = this;
                    var data = resultList;
                    _self.surveyData = data.data;
                    var _surveyTpl = _.template($("#surveyTemplate").html())
                    $('#survey-wrapper').html(_surveyTpl({
                        recordList: data.data.survey || []
                    }))
                    // 填充其他类型问卷
                    const tmpSurvey = JSON.parse(JSON.stringify(data.data));
                    tmpSurvey.survey.splice(3, tmpSurvey.survey.length - 3);
                    _self.otherSurveyData = tmpSurvey;
                    // 读取问卷默认结果，渲染已选效果
                    _self.readSurvey(data.data.survey);
                    _self.initPage();
                    // 读取第一题结果，动态切换原始问卷
                    _self.switchSurvey();
                    // 根据问卷数据更新副标题
                    let hasCollect = false;
                    data.data.survey[2].choices.forEach(item => {
                        if (item.value) {
                            hasCollect = true;
                        }
                    })
                    hasCollect && $('.sub-title').html('以便搜款网为您提供更好的服务/商品');
                        
                    // api.service.user.surveyList({}, function (data) {
                    //     if (data.code === 200) {
                    //         _self.surveyData = data.data;
                    //         var _surveyTpl = _.template($("#surveyTemplate").html())
                    //         $('#survey-wrapper').html(_surveyTpl({
                    //             recordList: data.data.survey || []
                    //         }))
                    //         // 填充其他类型问卷
                    //         const tmpSurvey = JSON.parse(JSON.stringify(data.data));
                    //         tmpSurvey.survey.splice(3, tmpSurvey.survey.length - 3);
                    //         _self.otherSurveyData = tmpSurvey;
                    //         // 读取问卷默认结果，渲染已选效果
                    //         _self.readSurvey(data.data.survey);
                    //         _self.initPage();
                    //         // 读取第一题结果，动态切换原始问卷
                    //         _self.switchSurvey();
                    //         // 根据问卷数据更新副标题
                    //         let hasCollect = false;
                    //         data.data.survey[2].choices.forEach(item => {
                    //             if (item.value) {
                    //                 hasCollect = true;
                    //             }
                    //         })
                    //         hasCollect && $('.sub-title').html('以便搜款网为您提供更好的服务/商品');
                    //     } else {
                    //         layer.msg('网络异常，请重试', {
                    //             time: 3000
                    //         })
                    //     }
                    // })
                },
                addDynamicSurvey: function (target, parent) {
                    var self = this;
                    let domStr = `<div class="add-content single-content content" id=auto-${target.data('id')}>`;
                    if (target.data('style') == 4) {
                        // 动态添加输入框
                        domStr += `<input type="text" data-id=${target.data('id')} placeholder="请输入 ${target.data('name')}" /></div>`;
                        parent.append(domStr);
                    } else if (target.data('choices') && target.data('choices').length > 0) {
                        // 动态添加勾选框
                        self.getSubChoices(self.surveyData.survey, target.data('id'));
                        if (target.data('style') == 3) {
                            domStr += '<div class="angle"></div>';
                        }
                        self.currAddChoices.forEach(item => {
                            domStr += `<div class="sub-item item" data-id=${item.id} data-style=${item.style}>${item.choiceName}</div>`;
                        })
                        domStr += '</div>'
                        parent.append(domStr);
                        // 动态调整左移距离
                        const autoLeft = target.context.offsetLeft - ($(`#auto-${target.data('id')}`).width() / 2) + target.width();
                        $(`#auto-${target.data('id')}`).css('left', autoLeft);
                    }
                },
                getSubChoices: function (arr, id) {
                    var _self = this;
                    arr.forEach((item) => {
                        if (item.id.toString() == id) {
                            _self.currAddChoices = item.choices;
                            return;
                        }
                        if (item.choices && item.choices.length) {
                            _self.getSubChoices(item.choices, id);
                        }
                    })
                },
                clickSubChoice: function (event) {
                    if ($(event.target).parents().hasClass('add-content')) {
                        const parent = $(event.target).parents('.add-content');
                        $.each(parent.find('.item'), (index, item) => {
                            $(item).removeClass('selected');
                        })
                        $(event.target).addClass('selected');
                        return true;
                    }
                    return false;
                },
                submitSurvey: function () {
                    var _self = this;
                    if (!_self.validatePage()) {
                        return;
                    }
                    const submit = (text) => {
                        api.service.user.submitSurvey(_self.surveyData, function (data) {
                            if (data.code === 200) {
                                layer.msg(text, {
                                    time: 2000
                                })
                                // if (text == '提交成功') {
                                //     layer.open({
                                //         title: "提交成功",
                                //         content: data.data.coupon_content,
                                //         btn: ['查看我的优惠券'],
                                //         area: ['390px', 'auto'],
                                //         yes: function() {
                                //             console.log(1);
                                //         }
                                //     });
                                // } else {
                                setTimeout(() => {
                                    window.location.href = '/user/home.html';
                                }, 2000);
                                // }
                            } else {
                                layer.msg('网络异常，请重试', {
                                    time: 2000
                                })
                            }
                        })
                    }
                    if (JSON.stringify(_self.selectedValue) == '{}') {
                        submit('提交成功');
                    } else if (!deepEqual(_self.selectedValue, _self.newSelectedValue)) {
                        layer.open({
                            title: "是否更新用户信息?",
                            content: '',
                            btn: ['取消', '确定'],
                            area: ['390px', 'auto'],
                            cancel: function () {},
                            yes: function () {
                                submit('信息更新成功')
                            }
                        });
                    } else {
                        layer.msg('请做出更新再提交', {
                            time: 2000
                        })
                    }
                },
                /**
                 * 更新问卷结果
                 * arr: 递归数组，即问卷数组
                 * seleced： 已选标签的id以及value的键值对object
                 */
                updateSurvey: function (arr, selected) {
                    var _self = this;
                    arr.forEach((item) => {
                        if (Object.keys(selected).includes(item.id.toString())) {
                            item.value = selected[item.id]
                        } else {
                            item.value = null
                        }
                        if (item.choices && item.choices.length) {
                            _self.updateSurvey(item.choices, selected);
                        }
                    })
                },
                /**
                 * 读取问卷源数据结果，用于加载初始话问卷
                 * */
                readSurvey: function (arr) {
                    var _self = this;
                    arr.forEach((item) => {
                        if (item.value) {
                            _self.selectedValue[item.id] = item.value;
                        }
                        if (item.choices && item.choices.length) {
                            _self.readSurvey(item.choices);
                        }
                    })
                },
                updatePage: function (direction) {
                    var _self = this;
                    if (direction == 'next') {
                        if (!_self.validatePage()) {
                            return;
                        }
                        _self.switchSurvey();
                        _self.pageIndex += 1;
                    } else {
                        _self.pageIndex -= 1;
                    }
                    $('.current-page').html(_self.pageIndex + 1);
                    switch (_self.pageIndex) {
                        case 0:
                            $('.go-next').css('display', 'block');
                            $('.go-previous').css('display', 'none');
                            $('.go-submit').css('display', 'none');
                            break;
                        case 1: 
                            $('.go-next').css('display', _self.surveyType == 'og' ? 'block' : 'none');
                            $('.go-previous').css('display', 'block');
                            $('.go-submit').css('display', _self.surveyType == 'og' ? 'none' : 'block');
                            break;
                        case 2:
                            $('.go-next').css('display', 'none');
                            $('.go-previous').css('display', 'block');
                            $('.go-submit').css('display', 'block');
                            break;
                        default:
                            break;
                    }
                    $.each($('.user-main .survey-wrapper .page'), function (index, item) {
                        if ($(item).data('page') == _self.pageIndex) {
                            $(item).css('display', 'block');
                        } else {
                            $(item).css('display', 'none');
                        }
                    })
                },
                validatePage: function () {
                    var _self = this;
                    var result = true;
                    $.each($('.user-main .survey-wrapper .page'), function (index, item) {
                        if ($(item).data('page') == _self.pageIndex) {
                            // 第一题为特殊情况
                            if (_self.pageIndex == 0) {
                                if ($(item).find('.row .selected').length == 0) {
                                    layer.msg('每个问题请至少选择一项！', {
                                        time: 2000
                                    })
                                    result = false;
                                }
                            } else {
                                $.each($(item).find('.row'), function (index, rowItem) {
                                    let hasSelected = false;
                                    let msg = '每个问题请至少选择一项！';
                                    // 判断是否每一行都有选
                                    $.each($(rowItem).find('.item'), function (index, subItem) {
                                        if ($(subItem).hasClass('selected')) {
                                            hasSelected = true;
                                            // 判断有子选项，必须选'
                                            if ($(subItem).data('choices') && $(subItem).data('choices').length > 0) {
                                                msg = '选中项带有子选项，必须选！';
                                                if ($(`#auto-${$(subItem).data('id')}`).find('.selected').length == 0) {
                                                    hasSelected = false;
                                                }
                                            }
                                            // 判断'有输入项，必须填'
                                            if ($(subItem).data('style') == 4) {
                                                msg = '选中项有输入项，必须填！';
                                                if ($(`#auto-${$(subItem).data('id')}`).find('input').val() == '') {
                                                    hasSelected = false;
                                                }
                                            }
                                        }
                                    })
                                    if (!hasSelected) {
                                        layer.msg(msg, {
                                            time: 2000
                                        })
                                        result = false;
                                    }
                                })
                            }
                        }
                    })
                    return result;
                },
                // 切换问卷类型
                switchSurvey: function () {
                    var _self = this;
                    // 判断第一题的用户选择
                    const selectedIds = [];
                    $.each($('.first-quest').find('.selected'), function (index, item) {
                        selectedIds.push($(item).data('id'));
                    })
                    // 判断用户是否选择“其他内容”
                    let chooseOtherShop = true;
                    if (selectedIds.filter(item => item != 30 && item != 31 && item != 32).length > 0) {
                        chooseOtherShop = false;
                    }
                    // 切换至简易问卷
                    if (chooseOtherShop && _self.surveyType == 'og') {
                        _self.reloadSurvey(_self.otherSurveyData.survey, 'simple');
                    }
                    // 切换回普通问卷
                    if (!chooseOtherShop && _self.surveyType == 'simple') {
                        _self.reloadSurvey(_self.surveyData.survey, 'og');
                    }
                },
                // 重新加载问卷
                reloadSurvey: function(survey, type) {
                    var _self = this;
                    _self.selectedValue = {};
                    // 保留第一题已选的结果
                    const selectedValues = {};
                    $.each($('.user-main .survey-wrapper .selected'), function (index, item) {
                        // 3 为勾选型，4为输入型
                        selectedValues[item.dataset.id] = item.dataset.style == 3 ? item.dataset.id : $(`#auto-${item.dataset.id} input`).val();
                        if ($(item).parents('.row').find('.row-title').data('id')) {
                            selectedValues[$(item).parents('.row').find('.row-title').data('id')] = $(item).parents('.row').find('.row-title').data('id').toString();
                        }
                    })
                    _self.updateSurvey(survey, selectedValues);
                    // console.log(_self.otherSurveyData.survey);
                    // 重新渲染问卷
                    _self.surveyType = type;
                    const domId = type == 'simple' ? '#simpleSurveyTemplate' : '#surveyTemplate';
                    var _surveyTpl = _.template($(`${domId}`).html())
                    $('#survey-wrapper').html(_surveyTpl({
                        recordList: survey || []
                    }))
                    // 读取问卷默认结果，渲染已选效果
                    _self.readSurvey(survey);
                    _self.initPage();
                    // 更新总页数
                    const totalPage = type == 'simple' ? '2' : '3';
                    $('.total-page').html(totalPage);
                }
            })
            return new Main()
        }
    )
})(window, document);

deepEqual = function (x, y) {
    // 指向同一内存时
    if (x === y) {
        return true;
    } else if ((typeof x == "object" && x != null) && (typeof y == "object" && y != null)) {
        if (Object.keys(x).length != Object.keys(y).length)
        {return false;}

        for (var prop in x) {
            if (y.hasOwnProperty(prop)) {
                if (!deepEqual(x[prop], y[prop]))
                {return false;}
            } else
            {return false;}
        }
        return true;
    } else {
        return false;
    }
}